name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build the test Docker image
      working-directory: ./my-app
      run: docker build . --file Dockerfile.test --tag my-app-test:latest
      
    - name: Run tests in container
      working-directory: ./my-app
      run: docker run --name test-runner my-app-test:latest
    
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4      
        
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: ./my-app
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/my-app:latest

  notify-user:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    steps:
      - name: Send notification to user
        run: |          
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"            
          ESCAPED_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/[_*[\]()~`>#+\-=|{}.!]/\\&/g')          
         
          if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
            EMOJI="ğŸ‰"
            STATUS="Ğ’Ğ¡Ğ• Ğ­Ğ¢ĞĞŸĞ« ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ«"
          else
            EMOJI="âš ï¸"
            STATUS="ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ’ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ¡Ğ•"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_USER_ID }}" \
            -d "text=$EMOJI *CI/CD Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ*%0A%0AğŸ“¦ *Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹:* ${{ github.repository }}%0Aâœï¸ *ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚:* $ESCAPED_MESSAGE%0AğŸ”— *Ğ¥ĞµÑˆ:* \`${{ github.sha | slice: 0, 8 }}\`%0AğŸ§ª *Ğ¢ĞµÑÑ‚Ñ‹:* ${{ needs.test.result }}%0AğŸ³ *Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°:* ${{ needs.build.result }}%0A%0A$STATUS" \
            -d "parse_mode=MarkdownV2"
