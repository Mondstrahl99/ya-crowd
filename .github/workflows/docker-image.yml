name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build the test Docker image
      working-directory: ./my-app
      run: docker build . --file Dockerfile.test --tag my-app-test:latest
      
    - name: Run tests in container
      working-directory: ./my-app
      run: docker run --name test-runner my-app-test:latest
    
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4      
        
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: ./my-app
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/my-app:latest

  notify-user:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    steps:
      - name: Send notification to user
        run: |          
        
          if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
            EMOJI="üéâ"
            STATUS="–í–°–ï –≠–¢–ê–ü–´ –ü–†–û–ô–î–ï–ù–´"
          else
            EMOJI="‚ö†Ô∏è"
            STATUS="–û–®–ò–ë–ö–ê –í –ü–†–û–¶–ï–°–°–ï"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_USER_ID }}" \
            -d "text=$EMOJI *CI/CD –ó–ê–í–ï–†–®–ï–ù*%0A%0Aüì¶ *–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:* ${{ github.repository }}%0A‚úèÔ∏è *–ö–æ–º–º–∏—Ç:* ${{ github.event.head_commit.message }}%0Aüîó *–•–µ—à:* \`${{ github.sha }}\`%0Aüß™ *–¢–µ—Å—Ç—ã:* ${{ needs.test.result }}%0Aüê≥ *–°–±–æ—Ä–∫–∞:* ${{ needs.build.result }}%0A%0A$STATUS" \
          
